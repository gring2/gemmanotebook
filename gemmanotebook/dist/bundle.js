(()=>{"use strict";class e{createBlock(e,t,n="",s={}){const o=new Date;return{id:e,type:t,content:n,metadata:this.getDefaultMetadata(t,s),createdAt:o,updatedAt:o}}getDefaultMetadata(e,t){return{...{paragraph:{},"heading-1":{level:1},"heading-2":{level:2},"heading-3":{level:3},"heading-4":{level:4},"heading-5":{level:5},"heading-6":{level:6},quote:{},code:{language:"text"},"bullet-list":{level:0},"numbered-list":{level:0,number:1},checklist:{checked:!1,level:0},"horizontal-rule":{},image:{src:"",alt:"",width:600,caption:""}}[e],...t}}static isTextBlock(e){return["paragraph","heading-1","heading-2","heading-3","heading-4","heading-5","heading-6","quote","code"].includes(e)}static isListBlock(e){return["bullet-list","numbered-list","checklist"].includes(e)}static isHeadingBlock(e){return e.startsWith("heading-")}static getHeadingLevel(e){return this.isHeadingBlock(e)?parseInt(e.split("-")[1])||1:0}}class t{render(e){const t=document.createElement("div");t.className="block",t.dataset.blockId=e.id,t.dataset.blockType=e.type,t.draggable=!1;const n=document.createElement("div");n.className="drag-indicator top",t.appendChild(n);const s=document.createElement("div");s.className="drag-indicator bottom",t.appendChild(s);const o=this.createBlockMenu(e);t.appendChild(o);const i=document.createElement("div");i.className="block-type-indicator",i.textContent=this.getBlockTypeLabel(e.type),t.appendChild(i);const a=document.createElement("div");a.className="block-handle",a.innerHTML="‚ãÆ‚ãÆ",a.title="Click and drag to move",t.appendChild(a);const r=this.createContentElement(e);return t.appendChild(r),t}createBlockMenu(e){const t=document.createElement("div");t.className="block-menu";const n=document.createElement("button");return n.className="menu-button add-button",n.innerHTML="+",n.title="Add block below",t.appendChild(n),t}createContentElement(e){switch(e.type){case"paragraph":default:return this.createParagraphElement(e);case"heading-1":case"heading-2":case"heading-3":case"heading-4":case"heading-5":case"heading-6":return this.createHeadingElement(e);case"quote":return this.createQuoteElement(e);case"code":return this.createCodeElement(e);case"bullet-list":return this.createBulletListElement(e);case"numbered-list":return this.createNumberedListElement(e);case"checklist":return this.createChecklistElement(e);case"horizontal-rule":return this.createHorizontalRuleElement(e);case"image":return this.createImageElement(e)}}createParagraphElement(e){const t=document.createElement("div");return t.className="block-content",t.contentEditable="true",t.textContent=e.content,t.setAttribute("data-placeholder","Type '/' for commands, or just start writing..."),t}createHeadingElement(e){const t=parseInt(e.type.split("-")[1])||1,n=document.createElement(`h${t}`);return n.className=`block-content heading-${t}`,n.contentEditable="true",n.textContent=e.content,n.setAttribute("data-placeholder",`Heading ${t}`),n}createQuoteElement(e){const t=document.createElement("blockquote");return t.className="block-content quote",t.contentEditable="true",t.textContent=e.content,t.setAttribute("data-placeholder","Empty quote"),t}createCodeElement(e){const t=document.createElement("div");t.className="code-block";const n=document.createElement("select");n.className="language-select",n.style.cssText="margin-bottom: 8px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;",["text","javascript","typescript","python","java","html","css","json","markdown"].forEach(t=>{const s=document.createElement("option");s.value=t,s.textContent=t,s.selected=t===(e.metadata?.language||"text"),n.appendChild(s)});const s=document.createElement("pre"),o=document.createElement("code");return o.className="block-content",o.contentEditable="true",o.textContent=e.content,o.style.cssText="outline: none; background: transparent;",o.setAttribute("data-placeholder","Enter code..."),s.appendChild(o),t.appendChild(n),t.appendChild(s),n.addEventListener("change",()=>{e.metadata={...e.metadata,language:n.value}}),t}createBulletListElement(e){const t=document.createElement("div");t.className="list-item";const n=document.createElement("span");n.className="list-marker",n.textContent="‚Ä¢";const s=document.createElement("div");return s.className="block-content",s.contentEditable="true",s.textContent=e.content,t.appendChild(n),t.appendChild(s),t}createNumberedListElement(e){const t=document.createElement("div");t.className="list-item";const n=document.createElement("span");n.className="list-marker",n.textContent=`${e.metadata?.number||1}.`;const s=document.createElement("div");return s.className="block-content",s.contentEditable="true",s.textContent=e.content,t.appendChild(n),t.appendChild(s),t}createChecklistElement(e){const t=document.createElement("div");t.className="list-item checklist-item";const n=document.createElement("input");n.type="checkbox",n.checked=e.metadata?.checked||!1;const s=document.createElement("div");return s.className="block-content",s.contentEditable="true",s.textContent=e.content,n.addEventListener("change",()=>{e.metadata={...e.metadata,checked:n.checked},n.checked?(s.style.textDecoration="line-through",s.style.color="#888"):(s.style.textDecoration="none",s.style.color="inherit")}),n.checked&&(s.style.textDecoration="line-through",s.style.color="#888"),t.appendChild(n),t.appendChild(s),t}createHorizontalRuleElement(e){const t=document.createElement("hr");return t.className="horizontal-rule",t}createImageElement(e){const t=document.createElement("div");t.className="image-block";const n=document.createElement("div");if(n.className="image-container",e.metadata?.src){const s=document.createElement("img");s.src=e.metadata.src,s.alt=e.metadata.alt||"",s.className="block-image",s.draggable=!1,e.metadata.width&&(s.style.width=`${e.metadata.width}px`),n.appendChild(s);const o=document.createElement("div");o.className="image-resize-handle",o.innerHTML="‚Üò",n.appendChild(o);const i=document.createElement("div");i.className="image-caption block-content",i.contentEditable="true",i.textContent=e.metadata.caption||"",i.setAttribute("data-placeholder","Add a caption..."),t.appendChild(n),t.appendChild(i),this.setupImageResize(s,o,e)}else{const s=document.createElement("div");s.className="image-upload-area",s.innerHTML='\n        <div class="upload-placeholder">\n          <div class="upload-icon">üìÅ</div>\n          <div class="upload-text">Click to upload or drag an image here</div>\n          <div class="upload-formats">Supports JPG, PNG, GIF, WebP</div>\n        </div>\n      ';const o=document.createElement("input");o.type="file",o.accept="image/*",o.style.display="none",s.appendChild(o),n.appendChild(s),t.appendChild(n),this.setupImageUpload(s,o,e)}return t}getBlockTypeLabel(e){switch(e){case"paragraph":default:return"";case"heading-1":return"H1";case"heading-2":return"H2";case"heading-3":return"H3";case"heading-4":return"H4";case"heading-5":return"H5";case"heading-6":return"H6";case"quote":return"QUOTE";case"code":return"CODE";case"bullet-list":return"LIST";case"numbered-list":return"NUM";case"checklist":return"TODO";case"horizontal-rule":return"HR";case"image":return"IMG"}}setupImageUpload(e,t,n){const s=e=>{if(!e.type.startsWith("image/"))return void alert("Please select an image file.");const t=new FileReader;t.onload=t=>{const s=t.target?.result;n.metadata={...n.metadata,src:s,alt:e.name,width:600,file:e};const o=new CustomEvent("imageUploaded",{detail:{blockId:n.id,imageData:s}});window.dispatchEvent(o)},t.readAsDataURL(e)};e.addEventListener("click",()=>{t.click()}),t.addEventListener("change",e=>{const t=e.target.files?.[0];t&&s(t)}),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("drag-over")}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("drag-over");const n=t.dataTransfer?.files;n&&n.length>0&&s(n[0])})}setupImageResize(e,t,n){let s=!1,o=0,i=0;t.addEventListener("mousedown",t=>{t.preventDefault(),s=!0,o=t.clientX,i=e.offsetWidth,document.body.style.cursor="nw-resize",document.body.style.userSelect="none"}),document.addEventListener("mousemove",t=>{if(!s)return;const a=t.clientX-o,r=Math.max(100,Math.min(800,i+a));e.style.width=`${r}px`,n.metadata&&(n.metadata.width=r)}),document.addEventListener("mouseup",()=>{s&&(s=!1,document.body.style.cursor="",document.body.style.userSelect="")})}static applyTextFormatting(e,t){let n=t;n=n.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),n=n.replace(/\*(.*?)\*/g,"<em>$1</em>"),n=n.replace(/~~(.*?)~~/g,"<del>$1</del>"),n=n.replace(/`(.*?)`/g,'<code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>'),n=n.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),n!==t&&(e.innerHTML=n)}}class n{constructor(e,t){this.currentSuggestion=null,this.suggestionTimeout=null,this.isGenerating=!1,this.SUGGESTION_DELAY=800,this.gemmaService=e,this.referenceManager=t}async requestSuggestion(e,t,n,s){this.clearSuggestion(),this.suggestionTimeout&&clearTimeout(this.suggestionTimeout),this.isGenerating||n.trim().length<3||(this.suggestionTimeout=setTimeout(async()=>{await this.generateSuggestion(e,t,n,s)},this.SUGGESTION_DELAY))}async generateSuggestion(e,t,n,s){if(!this.isGenerating)try{this.isGenerating=!0;const o=this.extractKeywords(n+" "+s),i=this.referenceManager.getRelevantContent(o,1e3),a=await this.gemmaService.generateCompletion(n,s,i);if(a&&a.trim()&&a!==n){const s=this.cleanSuggestion(n,a);s&&this.showInlineSuggestion(e,t,n,s)}}catch(e){console.error("Failed to generate inline suggestion:",e)}finally{this.isGenerating=!1}}cleanSuggestion(e,t){let n=t.trim();n.startsWith(e)&&(n=n.substring(e.length).trim());const s=n.split(" ");return s.length>10&&(n=s.slice(0,10).join(" ")+"..."),n.length>2?n:""}showInlineSuggestion(e,t,n,s){this.clearSuggestion();const o=this.createSuggestionElement(s),i=t.querySelector(".block-content");i&&(this.positionSuggestionElement(i,o),this.currentSuggestion={blockId:e,suggestion:s,originalText:n,isActive:!0,element:o},o.style.opacity="0",document.body.appendChild(o),requestAnimationFrame(()=>{o.style.transition="opacity 0.2s ease",o.style.opacity="0.5"}))}createSuggestionElement(e){const t=document.createElement("span");return t.className="inline-suggestion",t.textContent=e,t.style.cssText="\n      position: absolute;\n      color: #999;\n      font-family: inherit;\n      font-size: inherit;\n      line-height: inherit;\n      pointer-events: none;\n      white-space: pre-wrap;\n      z-index: 100;\n      opacity: 0.5;\n      font-style: italic;\n    ",t}positionSuggestionElement(e,t){const n=window.getSelection();if(!n||0===n.rangeCount)return;const s=n.getRangeAt(0).getBoundingClientRect();e.getBoundingClientRect(),t.style.left=`${s.left}px`,t.style.top=`${s.top}px`}acceptSuggestion(){if(!this.currentSuggestion||!this.currentSuggestion.isActive)return!1;const{blockId:e,suggestion:t,originalText:n}=this.currentSuggestion,s=n+t.replace(/\.\.\.$/,"");this.clearSuggestion();const o=new CustomEvent("acceptSuggestion",{detail:{blockId:e,newText:s}});return window.dispatchEvent(o),!0}clearSuggestion(){this.currentSuggestion?.element&&this.currentSuggestion.element.remove(),this.currentSuggestion=null,this.suggestionTimeout&&(clearTimeout(this.suggestionTimeout),this.suggestionTimeout=null)}hasSuggestion(){return this.currentSuggestion?.isActive??!1}getCurrentSuggestion(){return this.currentSuggestion}updateSuggestionPosition(e){if(!this.currentSuggestion||!this.currentSuggestion.element)return;const t=e.querySelector(".block-content");t&&this.positionSuggestionElement(t,this.currentSuggestion.element)}isSuggestionValid(e){return!!this.currentSuggestion&&e.startsWith(this.currentSuggestion.originalText)}destroy(){this.clearSuggestion(),this.suggestionTimeout&&clearTimeout(this.suggestionTimeout)}extractKeywords(e){const t=e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(e=>e.length>3).filter(e=>!this.isStopWord(e));return[...new Set(t)].slice(0,10)}isStopWord(e){return new Set(["this","that","with","have","will","from","they","been","were","said","each","which","their","time","about","there","could","other","more","very","what","know","just","first","into","over","think","also","your","work","life","only","new","would","come","its","after","way","who","may","say","great","where","much","should","well","large","use"]).has(e)}}class s{constructor(e,t){this.draggedElement=null,this.draggedBlockId=null,this.isDragging=!1,this.startY=0,this.startX=0,this.editor=e,this.editorElement=t,this.setupEventListeners()}setupEventListeners(){this.editorElement.addEventListener("mousedown",this.handleMouseDown.bind(this)),document.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.addEventListener("mouseup",this.handleMouseUp.bind(this))}handleMouseDown(e){const t=e.target;if(!t.closest(".block-handle"))return;const n=t.closest(".block");n&&(e.preventDefault(),e.stopPropagation(),this.draggedElement=n,this.draggedBlockId=n.dataset.blockId||null,this.startY=e.clientY,this.startX=e.clientX,setTimeout(()=>{this.draggedElement&&this.isDragging&&this.draggedElement.classList.add("dragging")},100))}handleMouseMove(e){if(!this.draggedElement||!this.draggedBlockId)return;const t=Math.abs(e.clientY-this.startY),n=Math.abs(e.clientX-this.startX);if(!this.isDragging&&(t>5||n>5)&&(this.isDragging=!0,this.draggedElement.classList.add("dragging"),document.body.style.cursor="grabbing",document.body.style.userSelect="none"),!this.isDragging)return;const s=this.getBlockElementUnderCursor(e.clientX,e.clientY);if(this.clearDragOverClasses(),s&&s!==this.draggedElement){const t=s.getBoundingClientRect(),n=t.top+t.height/2;e.clientY<n?s.classList.add("drag-over-top"):s.classList.add("drag-over-bottom")}}handleMouseUp(e){if(!this.isDragging||!this.draggedElement||!this.draggedBlockId)return void this.cleanup();const t=this.getBlockElementUnderCursor(e.clientX,e.clientY);if(t&&t!==this.draggedElement){const n=t.dataset.blockId;if(n){const s=t.getBoundingClientRect(),o=s.top+s.height/2,i=e.clientY<o;this.moveBlock(this.draggedBlockId,n,i)}}this.cleanup()}getBlockElementUnderCursor(e,t){const n=this.draggedElement?.style.display;this.draggedElement&&(this.draggedElement.style.display="none");const s=document.elementFromPoint(e,t),o=s?.closest(".block");return this.draggedElement&&void 0!==n&&(this.draggedElement.style.display=n),o}clearDragOverClasses(){this.editorElement.querySelectorAll(".block").forEach(e=>{e.classList.remove("drag-over-top","drag-over-bottom")})}moveBlock(e,t,n){const s=this.editor.getBlocks(),o=s.findIndex(t=>t.id===e),i=s.findIndex(e=>e.id===t);if(-1===o||-1===i||o===i)return;let a=i;n||(a=i+1),o<a&&a--,this.editor.moveBlock(e,a)}cleanup(){this.draggedElement&&this.draggedElement.classList.remove("dragging"),this.clearDragOverClasses(),document.body.style.cursor="",document.body.style.userSelect="",this.draggedElement=null,this.draggedBlockId=null,this.isDragging=!1}destroy(){this.cleanup()}}class o{constructor(o,i,a){this.blocks=[],this.currentBlockId=null,this.blockIdCounter=0,this.container=o,this.gemmaService=i,this.referenceManager=a,this.blockFactory=new e,this.blockRenderer=new t,this.inlineSuggestion=new n(i,a),this.initializeEditor(),this.setupEventListeners(),this.setupSuggestionHandlers(),this.dragAndDrop=new s(this,this.editorElement),this.addBlock("paragraph")}initializeEditor(){this.editorElement=this.container.querySelector("#editor"),this.editorElement||(this.editorElement=document.createElement("div"),this.editorElement.className="editor",this.editorElement.id="editor",this.container.appendChild(this.editorElement))}setupEventListeners(){this.editorElement.addEventListener("keydown",this.handleKeyDown.bind(this)),this.editorElement.addEventListener("input",this.handleInput.bind(this)),this.editorElement.addEventListener("click",this.handleClick.bind(this)),this.setupGlobalImageDragDrop()}setupSuggestionHandlers(){window.addEventListener("acceptSuggestion",e=>{const t=e,{blockId:n,newText:s}=t.detail;this.updateBlock(n,{content:s}),setTimeout(()=>{this.focusBlock(n,"end")},10)}),window.addEventListener("imageUploaded",e=>{const t=e,{blockId:n}=t.detail,s=this.getBlockById(n);s&&this.updateBlockElement(s)})}setupGlobalImageDragDrop(){this.editorElement.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer?.types.includes("Files")&&this.editorElement.classList.add("drag-over")}),this.editorElement.addEventListener("dragleave",e=>{e.preventDefault(),e.stopPropagation(),this.editorElement.contains(e.relatedTarget)||this.editorElement.classList.remove("drag-over")}),this.editorElement.addEventListener("drop",e=>{e.preventDefault(),e.stopPropagation(),this.editorElement.classList.remove("drag-over");const t=e.dataTransfer?.files;if(!t||0===t.length)return;const n=Array.from(t).filter(e=>e.type.startsWith("image/"));if(0===n.length)return void alert("Please drop image files only.");const s=this.getDropPosition(e.clientY);let o=s;const i=this.findEmptyImageBlockNear(s);n.forEach((e,t)=>{let n;if(0===t&&i)n=i.id;else{const e=i?s+t:o+t;n=this.addBlock("image","",e)}const a=new FileReader;a.onload=t=>{const s=t.target?.result;this.updateBlock(n,{metadata:{src:s,alt:e.name,width:600,file:e}})},a.readAsDataURL(e)})})}getDropPosition(e){const t=Array.from(this.editorElement.querySelectorAll(".block"));for(let n=0;n<t.length;n++){const s=t[n].getBoundingClientRect();if(e<=s.top+s.height/2)return n}return this.blocks.length}findEmptyImageBlockNear(e){const t=Math.max(0,e-2),n=Math.min(this.blocks.length,e+2+1);for(let e=t;e<n;e++){const t=this.blocks[e];if(t&&"image"===t.type&&(!t.metadata?.src||""===t.metadata.src))return t}return null}handleKeyDown(e){const t=e.target,n=t.closest(".block");if(!n)return;const s=n.dataset.blockId;if(s)switch(e.key){case"Enter":e.preventDefault(),this.handleEnterKey(s,e.shiftKey);break;case"Backspace":this.handleBackspaceKey(s,t);break;case"ArrowUp":this.handleArrowKey(s,"up");break;case"ArrowDown":this.handleArrowKey(s,"down");break;case"Tab":e.preventDefault(),this.inlineSuggestion.hasSuggestion()?this.inlineSuggestion.acceptSuggestion():this.handleTab(s,e.shiftKey);break;case"/":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.showAICommandPalette(s));break;case"Escape":this.inlineSuggestion.hasSuggestion()&&(e.preventDefault(),this.inlineSuggestion.clearSuggestion())}}handleInput(e){const t=e,n=e.target,s=n.closest(".block");if(!s)return;const o=s.dataset.blockId;if(!o)return;const i=this.getBlockById(o);if(!i)return;const a=n.textContent||"";if(i.content=a,this.inlineSuggestion.hasSuggestion()&&!this.inlineSuggestion.isSuggestionValid(a)&&this.inlineSuggestion.clearSuggestion(),this.handleMarkdownShortcuts(i,n),"insertText"===t.inputType&&" "!==t.data&&a.length>2){const e=this.getDocumentContext();this.inlineSuggestion.requestSuggestion(o,s,a,e)}this.inlineSuggestion.hasSuggestion()&&this.inlineSuggestion.updateSuggestionPosition(s),this.notifyChange()}handleClick(e){const t=e.target.closest(".block");if(this.inlineSuggestion.clearSuggestion(),t){const e=t.dataset.blockId;e&&this.setCurrentBlock(e)}}handleEnterKey(e,t){if(t)return void document.execCommand("insertLineBreak");const n=this.getBlockById(e);if(!n)return;const s=window.getSelection();if(!s)return;const o=s.getRangeAt(0),i=o.startContainer.textContent?.substring(0,o.startOffset)||"",a=o.startContainer.textContent?.substring(o.startOffset)||"";n.content=i,this.updateBlockElement(n);const r=this.blocks.findIndex(t=>t.id===e);if(-1===r)return;const c=this.addBlock("paragraph",a,r+1);setTimeout(()=>{this.focusBlock(c)},0)}handleBackspaceKey(e,t){const n=this.getBlockById(e);if(!n)return;const s=window.getSelection();if(s&&0!==s.rangeCount&&0===s.getRangeAt(0).startOffset&&(!n.content||""===n.content.trim())){const t=this.blocks.findIndex(t=>t.id===e);if(t>0){this.removeBlock(e);const n=this.blocks[t-1];n&&this.focusBlock(n.id,"end")}}}handleArrowKey(e,t){this.inlineSuggestion.clearSuggestion();const n=this.blocks.findIndex(t=>t.id===e);"up"===t&&n>0?this.focusBlock(this.blocks[n-1].id,"end"):"down"===t&&n<this.blocks.length-1&&this.focusBlock(this.blocks[n+1].id,"start")}handleTab(e,t){const n=this.getBlockById(e);n&&n.type.includes("list")&&console.log("List indentation not yet implemented")}handleMarkdownShortcuts(e,t){const n=t.textContent||"",s=n.match(/^(#{1,6})\s(.*)$/);if(s){const t=s[1].length,n=s[2];return e.type=`heading-${t}`,e.content=n,this.updateBlockElement(e),void this.focusBlock(e.id,"end")}if(n.startsWith("> "))return e.type="quote",e.content=n.substring(2),this.updateBlockElement(e),void this.focusBlock(e.id,"end");if(n.startsWith("``` "))return e.type="code",e.content=n.substring(4),this.updateBlockElement(e),void this.focusBlock(e.id,"end");if("---"===n||"***"===n){e.type="horizontal-rule",e.content="",this.updateBlockElement(e);const t=this.addBlock("paragraph");return void this.focusBlock(t)}if(n.startsWith("- ")||n.startsWith("* "))return e.type="bullet-list",e.content=n.substring(2),this.updateBlockElement(e),void this.focusBlock(e.id,"end");const o=n.match(/^(\d+)\.\s(.*)$/);return o?(e.type="numbered-list",e.content=o[2],this.updateBlockElement(e),void this.focusBlock(e.id,"end")):n.startsWith("- [ ] ")||n.startsWith("- [x] ")?(e.type="checklist",e.content=n.substring(6),e.metadata={checked:n.includes("[x]")},this.updateBlockElement(e),void this.focusBlock(e.id,"end")):"/image"===n||"/img"===n?(e.type="image",e.content="",e.metadata={},void this.updateBlockElement(e)):void 0}addBlock(e,t="",n){const s="block-"+ ++this.blockIdCounter,o=this.blockFactory.createBlock(s,e,t);return void 0!==n?this.blocks.splice(n,0,o):this.blocks.push(o),this.renderBlock(o,n),this.notifyChange(),s}removeBlock(e){const t=this.blocks.findIndex(t=>t.id===e);if(-1!==t){this.blocks.splice(t,1);const n=this.editorElement.querySelector(`[data-block-id="${e}"]`);n&&n.remove(),this.notifyChange()}}updateBlock(e,t){const n=this.getBlockById(e);n&&(Object.assign(n,t),this.updateBlockElement(n),this.notifyChange())}moveBlock(e,t){const n=this.blocks.findIndex(t=>t.id===e);if(-1!==n&&t>=0&&t<this.blocks.length){const[e]=this.blocks.splice(n,1);this.blocks.splice(t,0,e),this.rerenderEditor(),this.notifyChange()}}renderBlock(e,t){const n=this.blockRenderer.render(e);void 0!==t&&t<this.editorElement.children.length?this.editorElement.insertBefore(n,this.editorElement.children[t]):this.editorElement.appendChild(n)}updateBlockElement(e){const t=this.editorElement.querySelector(`[data-block-id="${e.id}"]`);if(t){const n=this.blockRenderer.render(e);t.replaceWith(n)}}rerenderEditor(){this.editorElement.innerHTML="",this.blocks.forEach(e=>this.renderBlock(e))}getBlockById(e){return this.blocks.find(t=>t.id===e)}setCurrentBlock(e){this.currentBlockId=e}focusBlock(e,t="start"){const n=this.editorElement.querySelector(`[data-block-id="${e}"] .block-content`);if(n){n.focus();const e=window.getSelection(),s=document.createRange();"end"===t?(s.selectNodeContents(n),s.collapse(!1)):(s.setStart(n,0),s.collapse(!0)),e?.removeAllRanges(),e?.addRange(s)}}getDocumentContext(){return this.blocks.map(e=>e.content).join("\n")}getReferenceContext(e){const t=e+" "+this.getDocumentContext(),n=this.extractKeywords(t);return this.referenceManager.getRelevantContent(n,2e3)}extractKeywords(e){const t=e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(e=>e.length>3).filter(e=>!this.isStopWord(e));return[...new Set(t)].slice(0,15)}isStopWord(e){return new Set(["this","that","with","have","will","from","they","been","were","said","each","which","their","time","about","there","could","other","more","very","what","know","just","first","into","over","think","also","your","work","life","only","new","would","come","its","after","way","who","may","say","great","where","much","should","well","large","use","make","write","generate","create","please","help"]).has(e)}notifyChange(){const e=new CustomEvent("editorChange",{detail:{blocks:this.blocks}});window.dispatchEvent(e)}getState(){return{blocks:[...this.blocks],currentBlockId:this.currentBlockId}}loadContent(e){this.blocks=[...e.blocks],this.currentBlockId=e.currentBlockId,this.blockIdCounter=Math.max(...this.blocks.map(e=>parseInt(e.id.split("-")[1])||0)),this.rerenderEditor()}getBlocks(){return[...this.blocks]}showAutoCompletionNotification(e){const t=document.createElement("div");t.textContent=e,t.style.cssText="\n      position: fixed;\n      top: 70px;\n      right: 20px;\n      background: #4caf50;\n      color: white;\n      padding: 8px 16px;\n      border-radius: 4px;\n      font-size: 14px;\n      z-index: 1000;\n      animation: slideInRight 0.3s ease;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n    ",document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease",setTimeout(()=>{t.parentNode&&t.remove()},300)},2e3)}async insertAIGeneratedContent(e,t=!0){try{const n=this.getDocumentContext(),s=this.getReferenceContext(e);let o=this.blocks.length;t&&this.currentBlockId&&(o=this.blocks.findIndex(e=>e.id===this.currentBlockId)+1);const i=this.addBlock("paragraph","ü§ñ Generating content...",o),a=await this.gemmaService.composeDocument(e,n,s);a&&a.trim()?(this.removeBlock(i),this.insertGeneratedContentAsBlocks(a,o),this.showAutoCompletionNotification("AI content generated and inserted!")):(this.removeBlock(i),this.showAutoCompletionNotification("No content generated"))}catch(e){console.error("AI content generation failed:",e),this.showAutoCompletionNotification("AI generation failed")}}insertGeneratedContentAsBlocks(e,t){const n=e.split("\n").filter(e=>e.trim());let s=t;for(const e of n){const t=e.trim();if(!t)continue;let n="paragraph",o=t,i={};const a=t.match(/^(#{1,6})\s(.+)$/);if(a){const e=a[1].length;n=`heading-${e}`,o=a[2],i={level:e}}else if(t.startsWith("- "))n="bullet-list",o=t.substring(2),i={level:0};else if(t.match(/^\d+\.\s/)){n="numbered-list";const e=t.match(/^(\d+)\.\s(.+)$/);e&&(o=e[2],i={level:0,number:parseInt(e[1])})}else t.startsWith("> ")?(n="quote",o=t.substring(2)):t.startsWith("```")&&(n="code",o=t.substring(3).trim(),i={language:o||"text"},o="");this.addBlock(n,o,s),s++}}async streamAIContentIntoEditor(e){try{const t=this.getDocumentContext(),n=this.getReferenceContext(e);let s=this.blocks.length;this.currentBlockId&&(s=this.blocks.findIndex(e=>e.id===this.currentBlockId)+1);const o=this.addBlock("paragraph","",s);let i="";await this.gemmaService.streamComposeDocument(e,e=>{i+=e,this.updateBlock(o,{content:i});const t=this.editorElement.querySelector(`[data-block-id="${o}"]`);t&&"function"==typeof t.scrollIntoView&&t.scrollIntoView({behavior:"smooth",block:"nearest"})},t,n),i.trim()&&(this.removeBlock(o),this.insertGeneratedContentAsBlocks(i,s),this.showAutoCompletionNotification("AI content streamed successfully!"))}catch(e){console.error("Streaming AI content failed:",e),this.showAutoCompletionNotification("Streaming failed")}}showAICommandPalette(e){const t=document.createElement("div");t.className="ai-command-palette",t.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: white;\n      border: 1px solid #ddd;\n      border-radius: 8px;\n      box-shadow: 0 4px 20px rgba(0,0,0,0.15);\n      padding: 20px;\n      width: 400px;\n      z-index: 1001;\n    ";const n=document.createElement("h3");n.textContent="ü§ñ AI Assistant",n.style.cssText="margin: 0 0 15px 0; color: #333;";const s=document.createElement("input");s.type="text",s.placeholder='What would you like me to write? (e.g., "Write a paragraph about...")',s.style.cssText="\n      width: 100%;\n      padding: 12px;\n      border: 1px solid #ddd;\n      border-radius: 4px;\n      font-size: 14px;\n      outline: none;\n      margin-bottom: 15px;\n    ";const o=document.createElement("div");o.style.cssText="display: flex; gap: 10px; justify-content: flex-end;";const i=document.createElement("button");i.textContent="Generate",i.style.cssText="\n      background: #2196f3;\n      color: white;\n      border: none;\n      padding: 8px 16px;\n      border-radius: 4px;\n      cursor: pointer;\n      font-size: 14px;\n    ";const a=document.createElement("button");a.textContent="Cancel",a.style.cssText="\n      background: #666;\n      color: white;\n      border: none;\n      padding: 8px 16px;\n      border-radius: 4px;\n      cursor: pointer;\n      font-size: 14px;\n    ";const r=async()=>{const e=s.value.trim();e&&(document.body.removeChild(t),await this.streamAIContentIntoEditor(e))},c=()=>{document.body.removeChild(t),this.focusBlock(e)};i.addEventListener("click",r),a.addEventListener("click",c),s.addEventListener("keydown",e=>{"Enter"===e.key?(e.preventDefault(),r()):"Escape"===e.key&&(e.preventDefault(),c())}),o.appendChild(a),o.appendChild(i),t.appendChild(n),t.appendChild(s),t.appendChild(o),document.body.appendChild(t),s.focus()}destroy(){this.inlineSuggestion.destroy(),this.dragAndDrop.destroy()}}class i{constructor(){this.storageKey="gemma-notebook",this.metadataKey="gemma-notebook-metadata"}async save(e,t){try{const n=JSON.stringify(t),s=this.getStorageData();s[e]=n,localStorage.setItem(this.storageKey,JSON.stringify(s)),this.updateMetadata(e,n.length),console.log(`Document saved: ${e}`)}catch(t){throw console.error("Failed to save document:",t),new Error(`Failed to save document: ${e}`)}}async load(e){try{const t=this.getStorageData()[e];if(!t)return null;const n=JSON.parse(t);return n.blocks=n.blocks.map(e=>({...e,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)})),console.log(`Document loaded: ${e}`),n}catch(t){throw console.error(`Failed to load document: ${e}`,t),new Error(`Failed to load document: ${e}`)}}async delete(e){try{const t=this.getStorageData();delete t[e],localStorage.setItem(this.storageKey,JSON.stringify(t)),this.removeMetadata(e),console.log(`Document deleted: ${e}`)}catch(t){throw console.error(`Failed to delete document: ${e}`,t),new Error(`Failed to delete document: ${e}`)}}async exists(e){return e in this.getStorageData()}async list(){try{const e=this.getMetadata();return Object.values(e).sort((e,t)=>t.updatedAt.getTime()-e.updatedAt.getTime())}catch(e){return console.error("Failed to list documents:",e),[]}}async export(e,t="json"){const n=await this.load(e);if(!n)throw new Error(`Document not found: ${e}`);switch(t){case"json":return JSON.stringify(n,null,2);case"markdown":return this.convertToMarkdown(n);case"text":return this.convertToText(n);default:throw new Error(`Unsupported export format: ${t}`)}}async import(e,t,n="json"){let s;switch(n){case"json":s=JSON.parse(t);break;case"markdown":s=this.convertFromMarkdown(t);break;case"text":s=this.convertFromText(t);break;default:throw new Error(`Unsupported import format: ${n}`)}await this.save(e,s)}getStorageData(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):{}}catch(e){return console.error("Failed to parse storage data:",e),{}}}getMetadata(){try{const e=localStorage.getItem(this.metadataKey),t=e?JSON.parse(e):{};return Object.values(t).forEach(e=>{e.createdAt=new Date(e.createdAt),e.updatedAt=new Date(e.updatedAt)}),t}catch(e){return console.error("Failed to parse metadata:",e),{}}}updateMetadata(e,t){const n=this.getMetadata(),s=new Date;n[e]?(n[e].updatedAt=s,n[e].size=t):n[e]={name:e,path:e,createdAt:s,updatedAt:s,size:t},localStorage.setItem(this.metadataKey,JSON.stringify(n))}removeMetadata(e){const t=this.getMetadata();delete t[e],localStorage.setItem(this.metadataKey,JSON.stringify(t))}convertToMarkdown(e){return e.blocks.map(e=>{switch(e.type){case"heading-1":return`# ${e.content}`;case"heading-2":return`## ${e.content}`;case"heading-3":return`### ${e.content}`;case"heading-4":return`#### ${e.content}`;case"heading-5":return`##### ${e.content}`;case"heading-6":return`###### ${e.content}`;case"quote":return`> ${e.content}`;case"code":return`\`\`\`${e.metadata?.language||""}\n${e.content}\n\`\`\``;case"bullet-list":return`- ${e.content}`;case"numbered-list":return`${e.metadata?.number||1}. ${e.content}`;case"checklist":return`- [${e.metadata?.checked?"x":" "}] ${e.content}`;case"horizontal-rule":return"---";default:return e.content}}).join("\n\n")}convertToText(e){return e.blocks.map(e=>e.content).join("\n\n")}convertFromMarkdown(e){const t=e.split("\n"),n=[];let s=0;for(const e of t){if(!e.trim())continue;const t="block-"+ ++s,o=new Date,i=e.match(/^(#{1,6})\s+(.*)$/);if(i){n.push({id:t,type:`heading-${i[1].length}`,content:i[2],metadata:{level:i[1].length},createdAt:o,updatedAt:o});continue}if(e.startsWith("> ")){n.push({id:t,type:"quote",content:e.substring(2),metadata:{},createdAt:o,updatedAt:o});continue}if(e.startsWith("```")){const s=e.substring(3).trim()||"text";n.push({id:t,type:"code",content:"",metadata:{language:s},createdAt:o,updatedAt:o});continue}if(e.startsWith("- ")||e.startsWith("* ")){n.push({id:t,type:"bullet-list",content:e.substring(2),metadata:{level:0},createdAt:o,updatedAt:o});continue}const a=e.match(/^(\d+)\.\s+(.*)$/);if(a){n.push({id:t,type:"numbered-list",content:a[2],metadata:{level:0,number:parseInt(a[1])},createdAt:o,updatedAt:o});continue}const r=e.match(/^-\s+\[([x\s])\]\s+(.*)$/);r?n.push({id:t,type:"checklist",content:r[2],metadata:{checked:"x"===r[1],level:0},createdAt:o,updatedAt:o}):"---"!==e.trim()&&"***"!==e.trim()?n.push({id:t,type:"paragraph",content:e,metadata:{},createdAt:o,updatedAt:o}):n.push({id:t,type:"horizontal-rule",content:"",metadata:{},createdAt:o,updatedAt:o})}return{blocks:n,currentBlockId:null}}convertFromText(e){const t=e.split("\n\n").filter(e=>e.trim()),n=[];let s=0;for(const e of t){const t="block-"+ ++s,o=new Date;n.push({id:t,type:"paragraph",content:e.trim(),metadata:{},createdAt:o,updatedAt:o})}return{blocks:n,currentBlockId:null}}async createBackup(e){const t=await this.load(e);if(!t)throw new Error(`Document not found: ${e}`);const n=`${e}.backup.${(new Date).toISOString().replace(/[:.]/g,"-")}`;return await this.save(n,t),n}async getStorageStats(){const e=this.getStorageData(),t=Object.keys(e).length,n=JSON.stringify(e).length;return{totalFiles:t,totalSize:n,usage:`${(n/1024).toFixed(2)} KB`}}}class a{constructor(){this.isConnected=!1,this.baseUrl="http://localhost:11434/api",this.modelName="gemma3:12b"}async initialize(){try{console.log("Initializing Gemma service...");const e=await fetch(`${this.baseUrl}/tags`);if(!e.ok)throw new Error(`Ollama API not accessible: ${e.status}`);const t=await e.json();if(!t.models||!t.models.some(e=>e.name===this.modelName||e.name.startsWith("gemma3:27b")))throw console.warn(`Model ${this.modelName} not found. Available models:`,t.models?.map(e=>e.name)),new Error(`Model ${this.modelName} not found in Ollama. Please install it first with: ollama pull ${this.modelName}`);this.isConnected=!0,console.log("Gemma service initialized successfully")}catch(e){throw console.error("Failed to initialize Gemma service:",e),this.isConnected=!1,e}}async generate(e,t={}){this.isConnected||await this.initialize();try{const n=await fetch(`${this.baseUrl}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:this.modelName,prompt:e,stream:!1,options:{num_predict:t.maxTokens||256,temperature:t.temperature||.7,top_p:t.topP||.9,stop:t.stopSequences||[]}})});if(!n.ok)throw new Error(`Generation failed: ${n.status}`);return(await n.json()).response||""}catch(e){throw console.error("Text generation failed:",e),e}}async streamGenerate(e,t,n={}){this.isConnected||await this.initialize();try{const s=await fetch(`${this.baseUrl}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:this.modelName,prompt:e,stream:!0,options:{num_predict:n.maxTokens||256,temperature:n.temperature||.7,top_p:n.topP||.9,stop:n.stopSequences||[]}})});if(!s.ok)throw new Error(`Stream generation failed: ${s.status}`);const o=s.body?.getReader();if(!o)throw new Error("Failed to get response reader");const i=new TextDecoder;for(;;){const{done:e,value:n}=await o.read();if(e)break;const s=i.decode(n).split("\\n").filter(e=>e.trim());for(const e of s)try{const n=JSON.parse(e);if(n.response&&t(n.response),n.done)return}catch(e){continue}}}catch(e){throw console.error("Stream generation failed:",e),e}}async generateCompletion(e,t,n=""){const s=`You are an AI writing assistant. Based on the document context${n?" and reference materials":""}, provide a natural, concise continuation.\n\nDocument context:\n${n?`${t}\n\n--- Reference Materials ---\n${n}`:t}\n\nCurrent text being written: "${e}"\n\nContinue the current text naturally. Provide ONLY the continuation text (no quotes, no repetition of the current text). Keep it to 1-10 words maximum. Be concise and relevant${n?". Use information from reference materials when relevant":""}:`;try{let t=(await this.generate(s,{maxTokens:32,temperature:.2,stopSequences:["\n",".","!","?","\r"]})).trim();return t=t.replace(/^["']|["']$/g,""),t=t.replace(/^(continue|completion|text):\s*/i,""),t.toLowerCase().startsWith(e.toLowerCase())&&(t=t.substring(e.length).trim()),t}catch(e){return console.error("Auto-completion failed:",e),""}}async generateFromChat(e,t="",n=""){const s=t&&n?`Document context: ${t}\n\nReference materials: ${n}`:t?`Document context: ${t}`:n?`Reference materials: ${n}`:"",o=s?`${s}\n\nUser message: ${e}\n\nProvide a helpful response using the available context and reference materials:`:`User message: ${e}\n\nProvide a helpful response:`;try{return await this.generate(o,{maxTokens:512,temperature:.7})}catch(e){throw console.error("Chat generation failed:",e),e}}async generateStreamFromChat(e,t,n="",s=""){const o=n&&s?`Document context: ${n}\n\nReference materials: ${s}`:n?`Document context: ${n}`:s?`Reference materials: ${s}`:"",i=o?`${o}\n\nUser message: ${e}\n\nProvide a helpful response using the available context and reference materials:`:`User message: ${e}\n\nProvide a helpful response:`;try{await this.streamGenerate(i,t,{maxTokens:512,temperature:.7})}catch(e){throw console.error("Streaming chat generation failed:",e),e}}async composeDocument(e,t="",n=""){const s=t&&n?`Document context: ${t}\n\nReference materials: ${n}`:t?`Document context: ${t}`:n?`Reference materials: ${n}`:"",o=s?`${s}\n\nInstruction: ${e}\n\nGenerate content based on the instruction, incorporating relevant information from the provided context and reference materials:`:`Instruction: ${e}\n\nGenerate content based on the instruction:`;try{return await this.generate(o,{maxTokens:1024,temperature:.6})}catch(e){throw console.error("Document composition failed:",e),e}}async streamComposeDocument(e,t,n="",s=""){const o=n&&s?`Document context: ${n}\n\nReference materials: ${s}`:n?`Document context: ${n}`:s?`Reference materials: ${s}`:"",i=o?`${o}\n\nInstruction: ${e}\n\nGenerate content based on the instruction, incorporating relevant information from the provided context and reference materials:`:`Instruction: ${e}\n\nGenerate content based on the instruction:`;try{await this.streamGenerate(i,t,{maxTokens:1024,temperature:.6})}catch(e){throw console.error("Streaming document composition failed:",e),e}}isReady(){return this.isConnected}getModelInfo(){return{name:this.modelName,baseUrl:this.baseUrl,connected:this.isConnected}}}class r{constructor(e,t,n,s){this.messages=[],this.messageIdCounter=0,this.isProcessing=!1,this.container=e,this.gemmaService=t,this.editor=n,this.referenceManager=s,this.initializeElements(),this.setupEventListeners(),this.addWelcomeMessage()}initializeElements(){if(this.messagesContainer=this.container.querySelector("#chat-messages"),this.inputElement=this.container.querySelector("#chat-input"),!this.messagesContainer||!this.inputElement)throw new Error("Chat interface elements not found");this.messagesContainer.style.cssText+="\n      max-height: 400px;\n      overflow-y: auto;\n      scroll-behavior: smooth;\n    "}setupEventListeners(){this.inputElement.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())}),this.inputElement.addEventListener("focus",()=>{this.inputElement.style.borderColor="#2196f3"}),this.inputElement.addEventListener("blur",()=>{this.inputElement.style.borderColor="#ddd"})}addWelcomeMessage(){const e={id:"msg-"+ ++this.messageIdCounter,role:"assistant",content:"Hello! I'm your AI assistant powered by Gemma3. I can help you with questions and guidance. For content generation, try:\n\n‚Ä¢ **Inline suggestions**: Just type - gray suggestions appear automatically (press Tab to accept, Esc to dismiss)\n‚Ä¢ **Chat commands**: \"Write a paragraph about...\" (generates directly in editor)\n‚Ä¢ **AI command palette**: Ctrl+/ (or Cmd+/) to open quick AI commands\n‚Ä¢ **Reference documents**: Upload .txt/.md files below - I'll use them as context for better responses\n\nWhat can I help you with?",timestamp:new Date};this.messages.push(e),this.renderMessage(e)}async sendMessage(){const e=this.inputElement.value.trim();if(!e||this.isProcessing)return;this.inputElement.value="",this.isProcessing=!0;const t={id:"msg-"+ ++this.messageIdCounter,role:"user",content:e,timestamp:new Date};this.messages.push(t),this.renderMessage(t);const n={id:"msg-"+ ++this.messageIdCounter,role:"assistant",content:"",timestamp:new Date,isStreaming:!0};this.messages.push(n);const s=this.renderMessage(n);try{const t=this.getDocumentContext(),o=this.getReferenceContext(e);this.isComposerCommand(e)?await this.handleComposerCommand(e,t,o,n,s):await this.handleChatMessage(e,t,o,n,s)}catch(e){console.error("Chat error:",e),n.content="Sorry, I encountered an error processing your message. Please try again.",n.isStreaming=!1,this.updateMessageElement(s,n)}finally{this.isProcessing=!1}}async handleChatMessage(e,t,n,s,o){let i="";await this.gemmaService.generateStreamFromChat(e,e=>{i+=e,s.content=i,this.updateMessageElement(o,s),this.scrollToBottom()},t,n),s.isStreaming=!1,this.updateMessageElement(o,s)}async handleComposerCommand(e,t,n,s,o){const i=this.extractInstruction(e),a=n?" (using reference materials)":"";s.content=`üéØ Generating content in your document${a}...`,s.isStreaming=!1,this.updateMessageElement(o,s);try{await this.editor.streamAIContentIntoEditor(i),s.content="‚úÖ Content has been generated and inserted into your document!"+(a?"\n\nüìö Used reference materials for context.":""),this.updateMessageElement(o,s)}catch(e){console.error("Content generation failed:",e),s.content="‚ùå Failed to generate content. Please try again.",this.updateMessageElement(o,s)}}isComposerCommand(e){const t=e.toLowerCase();return["write","generate","create","compose","draft","make","help me write","can you write","please write"].some(e=>t.includes(e))}extractInstruction(e){return e.replace(/^(write|generate|create|compose|draft|make)\s+/i,"").replace(/^(help me|can you|please)\s+(write|generate|create|compose|draft|make)\s+/i,"").trim()}renderMessage(e){const t=document.createElement("div");return t.className=`chat-message ${e.role}`,t.dataset.messageId=e.id,t.style.cssText=`\n      margin-bottom: 16px;\n      padding: 12px;\n      border-radius: 8px;\n      max-width: 85%;\n      word-wrap: break-word;\n      ${"user"===e.role?"background: #e3f2fd; margin-left: auto; text-align: right;":"background: #f5f5f5; margin-right: auto;"}\n    `,this.updateMessageElement(t,e),this.messagesContainer.appendChild(t),this.scrollToBottom(),t}updateMessageElement(e,t){if((e.querySelector(".message-content")||(()=>{const t=document.createElement("div");return t.className="message-content",t.style.cssText="line-height: 1.4; white-space: pre-wrap;",e.appendChild(t),t})()).textContent=t.content,t.isStreaming)e.querySelector(".streaming-indicator")||(()=>{const t=document.createElement("span");t.className="streaming-indicator",t.textContent=" ‚óè",t.style.cssText="color: #2196f3; animation: pulse 1s infinite;",e.appendChild(t)})();else{const t=e.querySelector(".streaming-indicator");t&&t.remove()}(e.querySelector(".message-timestamp")||(()=>{const t=document.createElement("div");return t.className="message-timestamp",t.style.cssText="font-size: 11px; color: #666; margin-top: 4px; opacity: 0.7;",e.appendChild(t),t})()).textContent=t.timestamp.toLocaleTimeString()}scrollToBottom(){this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}getDocumentContext(){return this.editor.getBlocks().map(e=>e.content).join("\n").substring(0,2e3)}getReferenceContext(e){const t=e+" "+this.getDocumentContext(),n=this.extractKeywords(t);return this.referenceManager.getRelevantContent(n,1500)}extractKeywords(e){const t=e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(e=>e.length>3).filter(e=>!this.isStopWord(e));return[...new Set(t)].slice(0,12)}isStopWord(e){return new Set(["this","that","with","have","will","from","they","been","were","said","each","which","their","time","about","there","could","other","more","very","what","know","just","first","into","over","think","also","your","work","life","only","new","would","come","its","after","way","who","may","say","great","where","much","should","well","large","use"]).has(e)}showNotification(e){const t=document.createElement("div");t.className="chat-notification",t.textContent=e,t.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: #4caf50;\n      color: white;\n      padding: 12px 20px;\n      border-radius: 4px;\n      font-size: 14px;\n      z-index: 1001;\n      animation: slideInRight 0.3s ease;\n    ",document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease",setTimeout(()=>{t.remove()},300)},3e3)}clearMessages(){this.messages=[],this.messagesContainer.innerHTML="",this.addWelcomeMessage()}getMessages(){return[...this.messages]}addSystemMessage(e){const t={id:"msg-"+ ++this.messageIdCounter,role:"assistant",content:e,timestamp:new Date};this.messages.push(t),this.renderMessage(t)}}class c{constructor(e,t,n={}){this.saveTimer=null,this.lastSaveTime=null,this.hasUnsavedChanges=!1,this.isInitialized=!1,this.editor=e,this.fileStorage=t,this.options={interval:3e4,filename:"current.json",enabled:!0,showStatus:!0,...n},this.initialize()}initialize(){this.isInitialized||(window.addEventListener("editorChange",this.handleEditorChange.bind(this)),document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),window.addEventListener("beforeunload",this.handleBeforeUnload.bind(this)),this.options.enabled&&this.startAutoSave(),this.isInitialized=!0,console.log("AutoSave initialized"))}handleEditorChange(){this.hasUnsavedChanges=!0,this.options.enabled&&this.restartAutoSave(),this.options.showStatus&&this.updateSaveStatus("unsaved")}handleVisibilityChange(){document.hidden&&this.hasUnsavedChanges&&this.saveNow()}handleBeforeUnload(e){if(this.hasUnsavedChanges){this.saveNow();const t="You have unsaved changes. Are you sure you want to leave?";return e.returnValue=t,t}}startAutoSave(){this.saveTimer&&clearInterval(this.saveTimer),this.saveTimer=setInterval(()=>{this.hasUnsavedChanges&&this.saveNow()},this.options.interval)}restartAutoSave(){this.options.enabled&&this.startAutoSave()}async saveNow(){if(this.hasUnsavedChanges)try{this.options.showStatus&&this.updateSaveStatus("saving");const e=this.editor.getState();await this.fileStorage.save(this.options.filename,e),this.hasUnsavedChanges=!1,this.lastSaveTime=new Date,this.options.showStatus&&this.updateSaveStatus("saved"),console.log(`Auto-saved at ${this.lastSaveTime.toLocaleTimeString()}`)}catch(e){console.error("Auto-save failed:",e),this.options.showStatus&&this.updateSaveStatus("error")}}enable(){this.options.enabled=!0,this.startAutoSave(),console.log("Auto-save enabled")}disable(){this.options.enabled=!1,this.saveTimer&&(clearInterval(this.saveTimer),this.saveTimer=null),console.log("Auto-save disabled")}setInterval(e){this.options.interval=e,this.options.enabled&&this.restartAutoSave(),console.log(`Auto-save interval set to ${e}ms`)}setFilename(e){this.options.filename=e,console.log(`Auto-save filename set to ${e}`)}getStatus(){return{enabled:this.options.enabled,interval:this.options.interval,filename:this.options.filename,lastSaveTime:this.lastSaveTime,hasUnsavedChanges:this.hasUnsavedChanges}}updateSaveStatus(e){const t=document.querySelector(".auto-save-status");t&&t.remove();const n=document.createElement("div");switch(n.className="auto-save-status",n.style.cssText="\n      position: fixed;\n      bottom: 20px;\n      left: 20px;\n      padding: 8px 16px;\n      border-radius: 4px;\n      font-size: 14px;\n      z-index: 1000;\n      transition: opacity 0.3s;\n    ",e){case"saved":n.style.background="#4caf50",n.style.color="white",n.textContent=`‚úì Saved at ${(new Date).toLocaleTimeString()}`;break;case"saving":n.style.background="#2196f3",n.style.color="white",n.textContent="üíæ Saving...";break;case"unsaved":n.style.background="#ff9800",n.style.color="white",n.textContent="‚óè Unsaved changes";break;case"error":n.style.background="#f44336",n.style.color="white",n.textContent="‚ùå Save failed"}document.body.appendChild(n),"saved"!==e&&"error"!==e||setTimeout(()=>{n.style.opacity="0",setTimeout(()=>{n.remove()},300)},3e3)}destroy(){window.removeEventListener("editorChange",this.handleEditorChange.bind(this)),document.removeEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),window.removeEventListener("beforeunload",this.handleBeforeUnload.bind(this)),this.saveTimer&&(clearInterval(this.saveTimer),this.saveTimer=null),this.hasUnsavedChanges&&this.saveNow(),this.isInitialized=!1,console.log("AutoSave destroyed")}async manualSave(e){const t=e||this.options.filename;try{this.options.showStatus&&this.updateSaveStatus("saving");const e=this.editor.getState();await this.fileStorage.save(t,e),this.hasUnsavedChanges=!1,this.lastSaveTime=new Date,this.options.showStatus&&this.updateSaveStatus("saved"),console.log(`Manually saved to ${t} at ${this.lastSaveTime.toLocaleTimeString()}`)}catch(e){throw console.error("Manual save failed:",e),this.options.showStatus&&this.updateSaveStatus("error"),e}}}class l{constructor(){this.STORAGE_KEY="gemma-notebook-references",this.documents=[],this.documentIdCounter=0,this.loadReferences()}async uploadFile(e){if(!this.isValidFileType(e))throw new Error("Invalid file type. Only .txt and .md files are supported.");if(e.size>1048576)throw new Error("File too large. Maximum size is 1MB.");try{const t=await this.readFileContent(e),n={id:"ref-"+ ++this.documentIdCounter,name:e.name,content:t.trim(),type:this.getFileType(e.name),uploadedAt:new Date,size:e.size};return this.documents.push(n),this.saveReferences(),n}catch(t){throw console.error("Failed to upload reference file:",t),new Error(`Failed to upload file: ${e.name}`)}}removeDocument(e){const t=this.documents.findIndex(t=>t.id===e);return-1!==t&&(this.documents.splice(t,1),this.saveReferences(),!0)}getDocument(e){return this.documents.find(t=>t.id===e)}getAllDocuments(){return[...this.documents]}getDocumentsContent(){return 0===this.documents.length?"":this.documents.map(e=>`### ${e.name}\n\n${e.content}`).join("\n\n--- Reference Document ---\n\n")}getDocumentsSummary(){return 0===this.documents.length?"No reference documents available.":`Reference documents available:\n${this.documents.map(e=>`- ${e.name} (${e.type}, ${this.formatFileSize(e.size)})`).join("\n")}`}clearAllDocuments(){this.documents=[],this.saveReferences()}getStats(){return{totalDocuments:this.documents.length,totalSize:this.documents.reduce((e,t)=>e+t.size,0),types:{text:this.documents.filter(e=>"text"===e.type).length,markdown:this.documents.filter(e=>"markdown"===e.type).length}}}isValidFileType(e){const t=e.name.toLowerCase();return[".txt",".md",".markdown"].some(e=>t.endsWith(e))}getFileType(e){const t=e.toLowerCase();return t.endsWith(".md")||t.endsWith(".markdown")?"markdown":"text"}async readFileContent(e){return new Promise((t,n)=>{const s=new FileReader;s.onload=e=>{const n=e.target?.result;t(n)},s.onerror=()=>{n(new Error("Failed to read file"))},s.readAsText(e,"UTF-8")})}loadReferences(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e);this.documents=t.documents.map(e=>({...e,uploadedAt:new Date(e.uploadedAt)})),this.documentIdCounter=Math.max(...this.documents.map(e=>parseInt(e.id.split("-")[1])||0),0)}}catch(e){console.error("Failed to load references:",e),this.documents=[]}}saveReferences(){try{const e={documents:this.documents,lastUpdated:new Date};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){throw console.error("Failed to save references:",e),new Error("Failed to save reference documents")}}formatFileSize(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,t)).toFixed(1))} ${["B","KB","MB"][t]}`}searchReferences(e){const t=[],n=e.toLowerCase();return this.documents.forEach(e=>{const s=e.content.split("\n"),o=[];s.forEach((e,t)=>{e.toLowerCase().includes(n)&&o.push({lineNumber:t+1,content:e.trim()})}),o.length>0&&t.push({document:e,matchingLines:o})}),t}getRelevantContent(e,t=2e3){if(0===this.documents.length)return"";const n=[];this.documents.forEach(t=>{t.content.split("\n\n").filter(e=>e.trim()).forEach(s=>{let o=0;const i=s.toLowerCase();e.forEach(e=>{const t=e.toLowerCase(),n=(i.match(new RegExp(t,"g"))||[]).length;o+=n*e.length}),o>0&&n.push({content:s.trim(),score:o,source:t.name})})}),n.sort((e,t)=>t.score-e.score);let s="";for(const e of n){const n=`[From ${e.source}]\n${e.content}\n\n`;if(!(s.length+n.length<=t))break;s+=n}return s.trim()}}class d{constructor(e,t){this.isExpanded=!1,this.container=e,this.referenceManager=t,this.createUI(),this.setupEventListeners()}createUI(){const e=document.createElement("div");e.className="references-section",e.innerHTML='\n      <div class="references-header" style="\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 10px 0;\n        border-bottom: 1px solid #eee;\n        margin-bottom: 10px;\n        cursor: pointer;\n      ">\n        <h4 style="margin: 0; color: #333; font-size: 14px;">\n          üìö References <span class="ref-count">(0)</span>\n        </h4>\n        <span class="expand-icon" style="\n          transform: rotate(0deg);\n          transition: transform 0.2s;\n          font-size: 12px;\n          color: #666;\n        ">‚ñº</span>\n      </div>\n      \n      <div class="references-content" style="\n        max-height: 0;\n        overflow: hidden;\n        transition: max-height 0.3s ease;\n      ">\n        <div class="upload-area" style="\n          border: 2px dashed #ddd;\n          border-radius: 6px;\n          padding: 20px;\n          text-align: center;\n          margin-bottom: 15px;\n          cursor: pointer;\n          transition: all 0.2s;\n        ">\n          <div style="color: #666; font-size: 14px; margin-bottom: 8px;">\n            üìÅ Drop files here or click to upload\n          </div>\n          <div style="color: #999; font-size: 12px;">\n            Supports .txt and .md files (max 1MB each)\n          </div>\n          <input type="file" multiple accept=".txt,.md,.markdown" style="display: none;" class="file-input">\n        </div>\n        \n        <div class="references-list" style="\n          max-height: 200px;\n          overflow-y: auto;\n        "></div>\n        \n        <div class="references-stats" style="\n          font-size: 12px;\n          color: #666;\n          margin-top: 10px;\n          padding-top: 10px;\n          border-top: 1px solid #eee;\n        "></div>\n      </div>\n    ',this.container.appendChild(e),this.updateUI()}setupEventListeners(){this.container.querySelector(".references-header").addEventListener("click",()=>{this.toggleExpanded()});const e=this.container.querySelector(".upload-area"),t=this.container.querySelector(".file-input");e.addEventListener("click",()=>{t.click()}),e.addEventListener("dragover",t=>{t.preventDefault(),e.style.borderColor="#2196f3",e.style.backgroundColor="#f8f9ff"}),e.addEventListener("dragleave",()=>{e.style.borderColor="#ddd",e.style.backgroundColor="transparent"}),e.addEventListener("drop",t=>{t.preventDefault(),e.style.borderColor="#ddd",e.style.backgroundColor="transparent";const n=Array.from(t.dataTransfer?.files||[]);this.handleFileUpload(n)}),t.addEventListener("change",e=>{const t=Array.from(e.target.files||[]);this.handleFileUpload(t)})}toggleExpanded(){this.isExpanded=!this.isExpanded;const e=this.container.querySelector(".references-content"),t=this.container.querySelector(".expand-icon");this.isExpanded?(e.style.maxHeight="400px",t.style.transform="rotate(180deg)"):(e.style.maxHeight="0",t.style.transform="rotate(0deg)")}async handleFileUpload(e){const t=e.map(async e=>{try{await this.referenceManager.uploadFile(e),this.showNotification(`‚úÖ Uploaded: ${e.name}`,"success")}catch(t){console.error("Upload failed:",t),this.showNotification(`‚ùå Failed: ${e.name} - ${t.message}`,"error")}});await Promise.all(t),this.updateUI(),!this.isExpanded&&e.length>0&&this.toggleExpanded()}updateUI(){this.updateReferencesList(),this.updateStats(),this.updateCount()}updateReferencesList(){const e=this.container.querySelector(".references-list"),t=this.referenceManager.getAllDocuments();0!==t.length?(e.innerHTML=t.map(e=>this.createDocumentElement(e)).join(""),e.querySelectorAll(".remove-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=e.dataset.docId;n&&this.removeDocument(n)})}),e.querySelectorAll(".reference-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.docId;t&&this.showDocumentPreview(t)})})):e.innerHTML='\n        <div style="\n          text-align: center;\n          color: #999;\n          font-size: 13px;\n          padding: 20px;\n        ">\n          No reference documents uploaded yet\n        </div>\n      '}createDocumentElement(e){const t="markdown"===e.type?"üìù":"üìÑ",n=e.content.length>100?e.content.substring(0,100)+"...":e.content;return`\n      <div class="reference-item" data-doc-id="${e.id}" style="\n        padding: 8px;\n        margin-bottom: 6px;\n        background: #f8f9fa;\n        border-radius: 4px;\n        cursor: pointer;\n        position: relative;\n        transition: background-color 0.2s;\n      " onmouseover="this.style.backgroundColor='#f0f0f0'" \n         onmouseout="this.style.backgroundColor='#f8f9fa'">\n        <div style="display: flex; align-items: center; justify-content: space-between;">\n          <div style="flex: 1; min-width: 0;">\n            <div style="\n              font-size: 13px;\n              font-weight: 500;\n              color: #333;\n              margin-bottom: 2px;\n              display: flex;\n              align-items: center;\n              gap: 6px;\n            ">\n              <span>${t}</span>\n              <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">\n                ${e.name}\n              </span>\n            </div>\n            <div style="\n              font-size: 11px;\n              color: #666;\n              white-space: nowrap;\n              overflow: hidden;\n              text-overflow: ellipsis;\n            ">\n              ${n}\n            </div>\n          </div>\n          <button class="remove-btn" data-doc-id="${e.id}" style="\n            background: #ff4444;\n            color: white;\n            border: none;\n            border-radius: 3px;\n            padding: 2px 6px;\n            font-size: 10px;\n            cursor: pointer;\n            margin-left: 8px;\n            opacity: 0.7;\n          " onmouseover="this.style.opacity='1'" \n             onmouseout="this.style.opacity='0.7'">√ó</button>\n        </div>\n      </div>\n    `}updateStats(){const e=this.container.querySelector(".references-stats"),t=this.referenceManager.getStats();if(0===t.totalDocuments)return void(e.innerHTML="");const n=this.formatFileSize(t.totalSize);e.innerHTML=`\n      üìä ${t.totalDocuments} document${t.totalDocuments>1?"s":""} \n      ‚Ä¢ ${n} total\n      ${t.types.markdown>0?`‚Ä¢ ${t.types.markdown} markdown`:""}\n      ${t.types.text>0?`‚Ä¢ ${t.types.text} text`:""}\n    `}updateCount(){const e=this.container.querySelector(".ref-count"),t=this.referenceManager.getAllDocuments().length;e.textContent=`(${t})`}removeDocument(e){const t=this.referenceManager.getDocument(e);t&&confirm(`Remove "${t.name}" from references?`)&&(this.referenceManager.removeDocument(e),this.updateUI(),this.showNotification(`üóëÔ∏è Removed: ${t.name}`,"info"))}showDocumentPreview(e){const t=this.referenceManager.getDocument(e);if(!t)return;const n=document.createElement("div");n.className="document-preview-modal",n.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0,0,0,0.5);\n      z-index: 2000;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding: 20px;\n    ";const s=document.createElement("div");s.style.cssText="\n      background: white;\n      border-radius: 8px;\n      padding: 20px;\n      max-width: 600px;\n      max-height: 80vh;\n      overflow: auto;\n      position: relative;\n    ",s.innerHTML=`\n      <div style="\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 15px;\n        padding-bottom: 10px;\n        border-bottom: 1px solid #eee;\n      ">\n        <h3 style="margin: 0; color: #333;">\n          ${"markdown"===t.type?"üìù":"üìÑ"} ${t.name}\n        </h3>\n        <button class="close-btn" style="\n          background: none;\n          border: none;\n          font-size: 20px;\n          cursor: pointer;\n          color: #666;\n          padding: 5px;\n        ">√ó</button>\n      </div>\n      <div style="\n        font-size: 12px;\n        color: #666;\n        margin-bottom: 15px;\n      ">\n        Uploaded: ${t.uploadedAt.toLocaleDateString()} ‚Ä¢ \n        Size: ${this.formatFileSize(t.size)} ‚Ä¢ \n        Type: ${t.type}\n      </div>\n      <pre style="\n        white-space: pre-wrap;\n        font-family: inherit;\n        font-size: 14px;\n        line-height: 1.5;\n        color: #333;\n        margin: 0;\n        background: #f8f9fa;\n        padding: 15px;\n        border-radius: 4px;\n        max-height: 400px;\n        overflow-y: auto;\n      ">${t.content}</pre>\n    `,n.appendChild(s),document.body.appendChild(n);const o=()=>n.remove();s.querySelector(".close-btn")?.addEventListener("click",o),n.addEventListener("click",e=>{e.target===n&&o()})}showNotification(e,t){const n=document.createElement("div");n.textContent=e,n.style.cssText=`\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      padding: 10px 15px;\n      border-radius: 4px;\n      font-size: 13px;\n      z-index: 1001;\n      max-width: 300px;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n      ${"success"===t?"background: #4caf50; color: white;":""}\n      ${"error"===t?"background: #f44336; color: white;":""}\n      ${"info"===t?"background: #2196f3; color: white;":""}\n    `,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateX(100%)",setTimeout(()=>n.remove(),300)},3e3)}formatFileSize(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,t)).toFixed(1))} ${["B","KB","MB"][t]}`}refresh(){this.updateUI()}expandSection(){this.isExpanded||this.toggleExpanded()}getReferencesCount(){return this.referenceManager.getAllDocuments().length}}class h{constructor(){this.initializeApp()}async initializeApp(){try{this.fileStorage=new i,this.gemmaService=new a,this.referenceManager=new l;const e=document.querySelector(".editor-container");this.editor=new o(e,this.gemmaService,this.referenceManager);const t=document.querySelector(".chat-container");this.chatInterface=new r(t,this.gemmaService,this.editor,this.referenceManager);const n=document.getElementById("reference-container");this.referenceUI=new d(n,this.referenceManager),this.autoSave=new c(this.editor,this.fileStorage),await this.gemmaService.initialize(),await this.loadDocument(),this.showStatus("App initialized successfully","success")}catch(e){console.error("Failed to initialize app:",e),this.showStatus("Failed to initialize app","error")}}async loadDocument(){try{const e=await this.fileStorage.load("current.json");e&&this.editor.loadContent(e)}catch(e){console.warn("No existing document found, starting with empty editor")}}showStatus(e,t="success"){const n=document.querySelector(".status");n&&n.remove();const s=document.createElement("div");s.className=`status ${t}`,s.textContent=e,document.body.appendChild(s),setTimeout(()=>{s.remove()},3e3)}}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("app");e&&(e.innerHTML='\n      <div class="app">\n        <div class="editor-container">\n          <div class="editor" id="editor"></div>\n        </div>\n        <div class="sidebar">\n          <div class="reference-section">\n            <h3>üìö Reference Documents</h3>\n            <div class="reference-container" id="reference-container">\n              \x3c!-- Reference UI will be inserted here --\x3e\n            </div>\n          </div>\n          <div class="chat-section">\n            <h3>ü§ñ AI Chat</h3>\n            <div class="chat-container">\n              <div class="chat-messages" id="chat-messages"></div>\n              <div class="chat-input">\n                <input type="text" id="chat-input" placeholder="Ask AI anything...">\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class="ai-help" title="AI Features:&#10;‚Ä¢ Type to get inline suggestions (Tab to accept)&#10;‚Ä¢ Press Ctrl+/ for AI command palette&#10;‚Ä¢ Chat with AI in the sidebar&#10;‚Ä¢ Upload reference documents for context">\n        ü§ñ AI Helper\n      </div>\n    '),new h})})();
//# sourceMappingURL=bundle.js.map